generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String        @id @default(uuid())
  email              String        @unique
  username           String        @unique
  password           String
  role               Role          @default(USER)
  isBlocked          Boolean       @default(false)
  failedLoginAttempts Int          @default(0)
  lastFailedLogin    DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  ratings            UserRating[]
  watchStatuses      WatchStatus[]

  @@map("users")
}

enum Role {
  USER
  ADMIN
}

model Movie {
  id              String            @id @default(uuid())
  title           String
  releaseYear     Int
  plot            String?
  posterUrl       String?
  tmdbId          Int?              @unique
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  genres          MovieGenre[]
  credits         MovieCredit[]
  externalRatings ExternalRating[]
  userRatings     UserRating[]
  watchStatuses   WatchStatus[]

  @@map("movies")
}

model Genre {
  id     String       @id @default(uuid())
  name   String       @unique
  movies MovieGenre[]

  @@map("genres")
}

model Person {
  id     String        @id @default(uuid())
  name   String
  type   PersonType
  movies MovieCredit[]

  @@map("people")
}

enum PersonType {
  ACTOR
  DIRECTOR
  PRODUCER
}

model MovieGenre {
  id      String @id @default(uuid())
  movieId String
  genreId String
  movie   Movie  @relation(fields: [movieId], references: [id], onDelete: Cascade)
  genre   Genre  @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@unique([movieId, genreId])
  @@map("movie_genres")
}

model MovieCredit {
  id            String  @id @default(uuid())
  movieId       String
  personId      String
  role          String
  characterName String?
  movie         Movie   @relation(fields: [movieId], references: [id], onDelete: Cascade)
  person        Person  @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@map("movie_credits")
}

model ExternalRating {
  id          String       @id @default(uuid())
  movieId     String
  source      RatingSource
  rating      Float
  ratingCount Int?
  movie       Movie        @relation(fields: [movieId], references: [id], onDelete: Cascade)

  @@unique([movieId, source])
  @@map("external_ratings")
}

enum RatingSource {
  IMDB
  ROTTEN_TOMATOES
}

model UserRating {
  id          String   @id @default(uuid())
  movieId     String
  userId      String
  rating      Float
  watchedDate DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  movie       Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([movieId, userId])
  @@map("user_ratings")
}

model WatchStatus {
  id          String   @id @default(uuid())
  movieId     String
  userId      String
  watched     Boolean  @default(true)
  watchedDate DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  movie       Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([movieId, userId])
  @@map("watch_statuses")
}
